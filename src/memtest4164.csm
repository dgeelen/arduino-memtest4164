.nolist                  // We don't want to actually include defs in our listing file.
.include "m328pdef.inc"  // defines all the pins on the ATMega328 so we can
                         // use them by their names rather than addresses (not fun).
.list                    // We DO want to include the following code in our listing ;D


#include "interrupts.csm"

ISR_SET_HANDLER(ISR_RESET,      main                               )
ISR_SET_HANDLER(ISR_USART_RX,   serial_interrupt_handler_rx        )
ISR_SET_HANDLER(ISR_USART_UDRE, serial_interrupt_handler_data_empty)
ISR_SET_HANDLER(ISR_TIMER0_COMPA, m4164_interrupt_handler_dram_refresh)
ISR_SET_ORG_FOR_USER_CODE()

#include <boost/preprocessor/seq/for_each.hpp>
#include "utility_macros.csm"
#include "utility_functions.csm"
#include "serial.csm"
#include "m4164.csm"
#include "libc.csm"

main:
	; set up the stack
	ldi    r25, low(RAMEND)
	out    SPL, r25
	ldi    r25, high(RAMEND)
	out    SPH, r25

	initialise_registers()

	serial_init(115200)

	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	;;  4164 DRAM setup                                                         ;;
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	; Configure timer0 to refresh the DRAM every 15.625us
	;
	; clear Force Compare, WGM02, select 1/256 prescaler
	ldi    r25, (0<<FOC0A)|(0<<FOC0B)|(0<<WGM02)|(1<<CS02)|(0<<CS01)|(0<<CS00)
	out    TCCR0B, r25
	; clear Compare Match Output, enable CTC mode
	ldi    r25, (0<<COM0A1)|(0<<COM0A0)|(0<<COM0B1)|(0<<COM0B0)|(1<<WGM01)|(0<<WGM00)
	out    TCCR0A, r25
	; Set compare value
	ldi    r25, 125 ; F_CPU=16Mhz, prescaler=1/256 --> trigger every 2ms
	out    OCR0A, r25
	out    OCR0B, r00 ; dont care
	; enable Compare Match A interrupt
	ldi    r25, (1<<OCIE0A)
	sts    TIMSK0, r25

	; Initialise m4164 driver
	; Physical connections:
	;
	;  N.C.  |  1  <---        --->  N.C. |  N/A
	;  Din   |  2  <--- Grey   --->  D12  |  Port B4
	; ~WE    |  3  <--- Black  --->  D10  |  Port B2
	; ~RAS   |  4  <--- Brown  --->  D9   |  Port B1
	;  A0    |  5  <--- Black  --->  D0   |  Port D0
	;  A2    |  6  <--- Grey   --->  D2   |  Port D2
	;  A1    |  7  <--- White  --->  D1   |  Port D1
	;  Vcc   |  8  <---        --->  N.C. |  N/A
	;  A7    |  9  <--- Orange --->  D7   |  Port D7
	;  A5    | 10  <--- Yellow --->  D5   |  Port D5
	;  A4    | 11  <--- Green  --->  D4   |  Port D4
	;  A3    | 12  <--- Blue   --->  D3   |  Port D3
	;  A6    | 13  <--- Purple --->  D6   |  Port D6
	;  Dout  | 14  <--- Red    --->  D8   |  Port B0
	; ~CAS   | 15  <--- White  --->  D11  |  Port B3
	;  Vss   | 16  <---        --->  N.C. |  N/A
	;
	ldi    zl, low(m4164_config)
	ldi    zh, high(m4164_config)
	ldi    r25, 128         $   std    z+m4164_config_row_count,    r25
	ldi    r25, 1<<PORTB2   $   std    z+m4164_config_WE_mask,      r25
	ldi    r25, 1<<PORTB4   $   std    z+m4164_config_Din_mask,     r25
	ldi    r25, 1<<PORTB0   $   std    z+m4164_config_Dout_mask,    r25
	ldi    r25, 1<<PORTB3   $   std    z+m4164_config_CAS_mask,     r25
	ldi    r25, 1<<PORTB1   $   std    z+m4164_config_RAS_mask,     r25

	ldi    zl, low(m4164_config)
	ldi    zh, high(m4164_config)
	call   m4164_init
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

	sei

	jmp run_all_tests

	#define TESTS                              \
		((10, "All Zeroes", ramtest_all_zeroes)) \
		(( 8, "All Ones"  , ramtest_all_ones  )) \
		(( 9, "Even bits" , ramtest_even_bits )) \
		(( 8, "Odd bits"  , ramtest_odd_bits  )) \
	// TESTS

	#define OP(i, data, elem) STRING_CONSTANT_N( \
		BOOST_PP_CAT(                              \
			BOOST_PP_TUPLE_ELEM(2, elem),            \
			_desc                                    \
		),                                         \
		BOOST_PP_TUPLE_ELEM(0, elem),              \
		BOOST_PP_TUPLE_ELEM(1, elem))              \
	// OP
	BOOST_PP_SEQ_FOR_EACH(OP, _, TESTS)
	#undef OP

test_names:
	#define OP(i, data, elem)                      \
		.db                                          \
			high(BOOST_PP_CAT(                         \
				BOOST_PP_TUPLE_ELEM(2, elem),            \
				_desc                                    \
			)),                                        \
			low(BOOST_PP_CAT(                          \
				BOOST_PP_TUPLE_ELEM(2, elem),            \
				_desc                                    \
			)),                                        \
		$                                            \
	// OP
	BOOST_PP_SEQ_FOR_EACH(OP, _, TESTS)
	#undef OP

test_funcs:
	#define OP(i, data, elem)                                           \
		.db                                                               \
			high(             BOOST_PP_TUPLE_ELEM(2, elem)        ),        \
			low (             BOOST_PP_TUPLE_ELEM(2, elem)        ),        \
			high(BOOST_PP_CAT(BOOST_PP_TUPLE_ELEM(2, elem), _desc)),        \
			low (BOOST_PP_CAT(BOOST_PP_TUPLE_ELEM(2, elem), _desc)),        \
		$                                                                 \
	// OP
	BOOST_PP_SEQ_FOR_EACH(OP, _, TESTS)
	.db 0, 0 ; end of list
	#undef OP

#undef TESTS


run_all_tests:
	ldi    r16, 00 ; total number of tests run
	ldi    r17, 00 ; number of failed tests
	ldi    xl, low(FLASH_ADDR(test_funcs))
	ldi    xh, high(FLASH_ADDR(test_funcs))

run_next_test:
	mov    zl, xl
	mov    zh, xh

	; load test addr
	lpm    yh, z
	adiw   zl, 1
	lpm    yl, z
	adiw   zl, 1

	cp     r00, yl
	cpc    r00, yh
	breq   run_tests_complete
	inc    r16

	; Determine and print test name
load_test_name:
	lpm    r25, z
	adiw   zl, 1
	lpm    r24, z
	adiw   zl, 1
	movw   xl, zl      ; save addr for next test
	push   r24         ; in-memory pointers are high, low
	push   r25
	ldi    r25, low(running_test)
	push   r25
	ldi    r25, high(running_test)
	push   r25
	call   _printf
	stack_free(4, r25)

	movw   zl, yl      ; set address of test

	icall              ; run test
	cpse   r25, r00    ; 0 = test passed, 1 = test failed
	rjmp   run_test_failed

run_test_passed:
	ldi    r25, low(test_passed)
	push   r25
	ldi    r25, high(test_passed)
	push   r25
	rjmp   run_test_print

run_test_failed:
	inc    r17
	ldi    r25, low(test_failed)
	push   r25
	ldi    r25, high(test_failed)
	push   r25

run_test_print:
	call   _printf
	stack_free(2, r25)

	jmp run_next_test

run_tests_complete:
	cpse   r17, r00
	rjmp   run_tests_complete_failed

run_tests_complete_passed:
	push   r16
	ldi    r25, low(test_result_passed)
	push   r25
	ldi    r25, high(test_result_passed)
	push   r25
	call   _printf
	stack_free(2, r25)
	ldi    r25, low(crlf)
	push   r25
	ldi    r25, high(crlf)
	push   r25
	call   _printf
	stack_free(2, r25)
	debug_break(50) // slow blink = ok

run_tests_complete_failed:
	; print 'bad chip'
	push   r16
	push   r17
	ldi    r25, low(test_result_failed)
	push   r25
	ldi    r25, high(test_result_failed)
	push   r25
	call   _printf
	stack_free(2, r25)
	; additional newline
	ldi    r25, low(crlf)
	push   r25
	ldi    r25, high(crlf)
	push   r25
	call   _printf
	stack_free(2, r25)
	debug_break(10) // fast blink = not ok



	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	;; Ram test -- All zeroes                                                   ;;
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
ramtest_all_zeroes:
	save_registers(r16)
	ldi    r16, 0
	call   ramtest_fill_memory
	call   ram_test_delay_short
	call   ramtest_compare_memory
	restore_registers(r16)
	ret
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	;; Ram test -- All ones                                                     ;;
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
ramtest_all_ones:
	save_registers(r16)
	ldi    r16, 0xff
	call   ramtest_fill_memory
	call   ram_test_delay_short
	call   ramtest_compare_memory
	restore_registers(r16)
	ret
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	;; Ram test -- Even bits                                                    ;;
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
ramtest_even_bits:
	save_registers(r16)
	ldi    r16, 0b10101010
	call   ramtest_fill_memory
	call   ram_test_delay_short
	call   ramtest_compare_memory
	restore_registers(r16)
	ret
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	;; Ram test -- Odd bits                                                     ;;
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
ramtest_odd_bits:
	save_registers(r16)
	ldi    r16, 0b01010101
	call   ramtest_fill_memory
	call   ram_test_delay_short
	call   ramtest_compare_memory
	restore_registers(r16)
	ret
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	;; Ram test -- fill memory                                                  ;;
	;; r16 -- value                                                             ;;
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
ramtest_fill_memory:
	save_registers(zl, zh)
	ldi    zl, 0
	ldi    zh, 0
__ramtest_fill_memory_next_byte:
	call   m4164_dram_write_byte; auto increment z
	cpi    zl, 0
	brne   __ramtest_fill_memory_next_byte
	cpi    zh, 0
	brne   __ramtest_fill_memory_next_byte
	restore_registers(zl, zh)
	ret
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	;; Ram test -- compare memory                                               ;;
	;; r16 -- expected value                                                    ;;
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
ramtest_compare_memory:
	save_registers(r23, zl, zh)
	ldi    zl, 0
	ldi    zh, 0
	mov    r23, r00
__ramtest_compare_memory_next_byte:
	call   m4164_dram_read_byte; auto increment z
	cpse   r16, r25
	mov    r23, r01
	cpi    zl, 0
	brne   __ramtest_compare_memory_next_byte
	cpi    zh, 0
	brne   __ramtest_compare_memory_next_byte
	mov    r25, r23
	restore_registers(r23, zl, zh)
	ret
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	;; Ram test -- delay                                                        ;;
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
ram_test_delay_n:
	eor    zh, zh                 ;      1       1
	eor    zl, zl                 ;      1       2
	mov    r25, r16               ;      1       3
__ram_test_delay_n:
	sub    zl, r01                ;      1       4
	sbc    zh, r00                ;      1       5
	brne   __ram_test_delay_n     ;    1/2       5 + 65534*2 + 1 = 131074
	dec    r25                    ;
	brne   __ram_test_delay_n
	ret
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	;; Ram test -- delay short                                                  ;;
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
ram_test_delay_short:
	push   r16
	ldi    r16, 1
	call   ram_test_delay_n
	pop    r16
	ret
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

.dseg
	serial_rx_byte: .byte 1
	m4164_config: .byte struct_m4164_config_size

.cseg


loop:
	mov    r16, r01
	ldi    zl, low(serial_rx_byte)
	ldi    zh, high(serial_rx_byte)
	call  serial_read

	lds    r25, serial_rx_byte
	push   r25
	ldi    r25, low(read_byte)
	push   r25
	ldi    r25, high(read_byte)
	push   r25
	call   _printf
	stack_free(3, r25)
	rjmp  loop


error_trap:
	break
	debug_break(4)
	rjmp error_trap



.set string_constants_reserved_space = 512
.set string_constants_org = (FLASHEND - string_constants_reserved_space + 1)/2
.if string_constants_org < (RAMEND+1)/2
	.error "String constants must be allocated at a flash address > RAMEND"
.endif
.org string_constants_org

STRING_CONSTANT_N(read_byte, 19, "read byte: '%hhx'", STRING_CONSTANT_CRLF);
STRING_CONSTANT_N(running_test, 20, "Running test '%s'...");
STRING_CONSTANT_N(test_passed, 9, " passed", STRING_CONSTANT_CRLF);
STRING_CONSTANT_N(test_failed, 9, " FAILED", STRING_CONSTANT_CRLF);
STRING_CONSTANT_N(test_result_passed, 72, "All %hhd tests completed successfully, this memory chip seems fine :-)", STRING_CONSTANT_CRLF);
STRING_CONSTANT_N(test_result_failed, 67, "%hhd of out %hhd tests failed, this memory chip may be broken :-(", STRING_CONSTANT_CRLF);
STRING_CONSTANT_N(crlf, 2, STRING_CONSTANT_CRLF);

string_constants_eof:
.if FLASH_ADDR(string_constants_eof) - 1 > FLASHEND
	.error "Not enough reserved space to store all string constants (ran out of flash!)"
.endif
